{"version":3,"file":"utils.js","sourceRoot":"","sources":["../src/utils.ts"],"names":[],"mappings":";;;;;;AAAA,sEAAyC;AACzC,mCAAmC;AACnC,mCAQiB;AACjB,2CAA2C;AAE3C,SAAgB,yBAAyB,CAAC,gBAAkC;IAC1E,OAAO,gBAAgB,CAAC,MAAM,KAAK,gCAAwB,CAAC,OAAO,CAAC;AACtE,CAAC;AAFD,8DAEC;AAEM,MAAM,gCAAgC,GAAG,CAC9C,MAAwC,EACxC,EAAE,CAAC,MAAM,KAAK,gBAAgB,CAAC;AAFpB,QAAA,gCAAgC,oCAEZ;AAEjC,0CAA0C;AAC1C,SAAgB,gBAAgB,CAAC,OAAgB,EAAE,OAAe;IAChE,MAAM,UAAU,GAAG,QAAQ,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;IACzC,QAAQ,OAAO,EAAE;QACf,KAAK,eAAO,CAAC,QAAQ,CAAC,CAAC;YACrB,OAAO,GAAG,wBAAY,aAAa,UAAU,UAAU,CAAC;SACzD;QAED,KAAK,eAAO,CAAC,YAAY,CAAC,CAAC;YACzB,OAAO,GAAG,wBAAY,aAAa,UAAU,cAAc,CAAC;SAC7D;QAED,KAAK,eAAO,CAAC,mBAAmB,CAAC,CAAC;YAChC,OAAO,GAAG,wBAAY,aAAa,UAAU,qBAAqB,CAAC;SACpE;QAED,KAAK,eAAO,CAAC,MAAM,CAAC,CAAC;YACnB,OAAO,GAAG,wBAAY,aAAa,UAAU,SAAS,CAAC;SACxD;QAED,KAAK,eAAO,CAAC,YAAY,CAAC,CAAC;YACzB,OAAO,GAAG,wBAAY,aAAa,UAAU,cAAc,CAAC;SAC7D;QAED,KAAK,eAAO,CAAC,QAAQ,CAAC,CAAC;YACrB,OAAO,GAAG,wBAAY,aAAa,UAAU,SAAS,CAAC;SACxD;QAED,OAAO,CAAC,CAAC;YACP,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC,CAAC,8CAA8C;SACnF;KACF;AACH,CAAC;AA/BD,4CA+BC;AAEM,MAAM,eAAe,GAAG,CAAC,MAA+B,EAAE,EAAE;IACjE,IAAI,wCAAgC,CAAC,MAAM,CAAC,EAAE;QAC5C,OAAO,gCAAwB,CAAC,QAAQ,CAAC;KAC1C;IACD,MAAM,aAAa,GAAG;QACpB,0CAAkC,CAAC,YAAY;QAC/C,0CAAkC,CAAC,SAAS;QAC5C,0CAAkC,CAAC,eAAe;QAClD,0CAAkC,CAAC,aAAa;QAChD,0CAAkC,CAAC,cAAc;KAClD,CAAC;IACF,IAAI,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,OAAO,MAAK,+BAAuB,CAAC,SAAS,EAAE;QACzD,IACE,MAAM,CAAC,kBAAkB;YACzB,0CAAkC,CAAC,aAAa,EAChD;YACA,OAAO,gCAAwB,CAAC,OAAO,CAAC;SACzC;QAED,MAAM,cAAc,GAClB,aAAa,CAAC,SAAS,CACrB,CAAC,YAAY,EAAE,EAAE,CAAC,YAAY,KAAK,MAAM,CAAC,kBAAkB,CAC7D,GAAG,CAAC,CAAC,CAAC;QACT,IAAI,MAAM,CAAC,kBAAkB,IAAI,cAAc,EAAE;YAC/C,OAAO,qCAA6B,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC;SACjE;KACF;SAAM,IAAI,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,OAAO,MAAK,+BAAuB,CAAC,OAAO,EAAE;QAC9D,OAAO,gCAAwB,CAAC,OAAO,CAAC;KACzC;SAAM,IAAI,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,OAAO,MAAK,+BAAuB,CAAC,QAAQ,EAAE;QAC/D,OAAO,gCAAwB,CAAC,QAAQ,CAAC;KAC1C;SAAM,IAAI,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,OAAO,MAAK,+BAAuB,CAAC,OAAO,EAAE;QAC9D,OAAO,gCAAwB,CAAC,OAAO,CAAC;KACzC;IACD,OAAO,gCAAwB,CAAC,OAAO,CAAC;AAC1C,CAAC,CAAC;AAlCW,QAAA,eAAe,mBAkC1B;AAEF;;;;;;;;;;;EAWE;AACF,SAAgB,oBAAoB,CAClC,aAAkB,EAClB,QAAa,EACb,IAAY;IAEZ,MAAM,KAAK,GAAQ,yBAAU,CAAC,OAAO,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC;IAC/D,2EAA2E;IAC3E,IAAI,KAAK,CAAC,CAAC,CAAC,EAAE;QACZ,IAAI,IAAI,EAAE;YACR,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,GAAG,IAAI,CAAC;SACtB;QAED,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;KACjC;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAfD,oDAeC;AAED;;;EAGE;AACF,SAAgB,aAAa,CAAC,aAAkB;IAC9C,MAAM,YAAY,GAAG,kBAAS,CAAC,aAAa,CAAC,CAAC;IAC9C,OAAO,YAAY,CAAC,MAAM,CACxB,CAAC,GAAQ,EAAE,KAAU,EAAE,EAAE,CAAC,yBAAU,CAAC,UAAU,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,WAAW,CACxE,CAAC;AACJ,CAAC;AALD,sCAKC;AAED;;;;GAIG;AACH,SAAgB,kBAAkB,CAAC,MAAW;IAC5C,MAAM,OAAO,qBAAQ,MAAM,CAAE,CAAC;IAC9B,OAAO,OAAO,CAAC,OAAO,CAAC;IACvB,OAAO,kBAAS,CAAC,OAAO,CAAC,CAAC;AAC5B,CAAC;AAJD,gDAIC;AAED;;;;GAIG;AACI,MAAM,oBAAoB,GAAG,CAClC,6BAAiD,EAC7B,EAAE;IACtB,IAAI,CAAC,6BAA6B,EAAE;QAClC,OAAO,SAAS,CAAC;KAClB;IACD,OAAO,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,6BAA6B,CAAC,GAAG,IAAI,CAAC,CAAC;AACzE,CAAC,CAAC;AAPW,QAAA,oBAAoB,wBAO/B;AAEK,KAAK,UAAU,WAAW,CAAC,OAAe,EAAE,OAAqB;IACtE,MAAM,QAAQ,GAAG,MAAM,KAAK,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IAC/C,MAAM,IAAI,GAAG,MAAM,QAAQ,CAAC,IAAI,EAAE,CAAC;IACnC,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE;QAChB,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,aAAa,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC;QACrD,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;QAClC,MAAM,IAAI,KAAK,CACb,eAAe,IAAI,CAAC,SAAS,CAAC;YAC5B,MAAM,EAAE,QAAQ,CAAC,MAAM;YACvB,IAAI;YACJ,OAAO;SACR,CAAC,EAAE,CACL,CAAC;KACH;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAfD,kCAeC","sourcesContent":["import jsonDiffer from 'fast-json-patch';\nimport { cloneDeep } from 'lodash';\nimport {\n  APIType,\n  SmartTransaction,\n  SmartTransactionsStatus,\n  SmartTransactionStatuses,\n  SmartTransactionCancellationReason,\n  SmartTransactionMinedTx,\n  cancellationReasonToStatusMap,\n} from './types';\nimport { API_BASE_URL } from './constants';\n\nexport function isSmartTransactionPending(smartTransaction: SmartTransaction) {\n  return smartTransaction.status === SmartTransactionStatuses.PENDING;\n}\n\nexport const isSmartTransactionStatusResolved = (\n  status: SmartTransactionsStatus | string,\n) => status === 'uuid_not_found';\n\n// TODO use actual url once API is defined\nexport function getAPIRequestURL(apiType: APIType, chainId: string): string {\n  const chainIdDec = parseInt(chainId, 16);\n  switch (apiType) {\n    case APIType.GET_FEES: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/getFees`;\n    }\n\n    case APIType.ESTIMATE_GAS: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/estimateGas`;\n    }\n\n    case APIType.SUBMIT_TRANSACTIONS: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/submitTransactions`;\n    }\n\n    case APIType.CANCEL: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/cancel`;\n    }\n\n    case APIType.BATCH_STATUS: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/batchStatus`;\n    }\n\n    case APIType.LIVENESS: {\n      return `${API_BASE_URL}/networks/${chainIdDec}/health`;\n    }\n\n    default: {\n      throw new Error(`Invalid APIType`); // It can never get here thanks to TypeScript.\n    }\n  }\n}\n\nexport const calculateStatus = (status: SmartTransactionsStatus) => {\n  if (isSmartTransactionStatusResolved(status)) {\n    return SmartTransactionStatuses.RESOLVED;\n  }\n  const cancellations = [\n    SmartTransactionCancellationReason.WOULD_REVERT,\n    SmartTransactionCancellationReason.TOO_CHEAP,\n    SmartTransactionCancellationReason.DEADLINE_MISSED,\n    SmartTransactionCancellationReason.INVALID_NONCE,\n    SmartTransactionCancellationReason.USER_CANCELLED,\n  ];\n  if (status?.minedTx === SmartTransactionMinedTx.NOT_MINED) {\n    if (\n      status.cancellationReason ===\n      SmartTransactionCancellationReason.NOT_CANCELLED\n    ) {\n      return SmartTransactionStatuses.PENDING;\n    }\n\n    const isCancellation =\n      cancellations.findIndex(\n        (cancellation) => cancellation === status.cancellationReason,\n      ) > -1;\n    if (status.cancellationReason && isCancellation) {\n      return cancellationReasonToStatusMap[status.cancellationReason];\n    }\n  } else if (status?.minedTx === SmartTransactionMinedTx.SUCCESS) {\n    return SmartTransactionStatuses.SUCCESS;\n  } else if (status?.minedTx === SmartTransactionMinedTx.REVERTED) {\n    return SmartTransactionStatuses.REVERTED;\n  } else if (status?.minedTx === SmartTransactionMinedTx.UNKNOWN) {\n    return SmartTransactionStatuses.UNKNOWN;\n  }\n  return SmartTransactionStatuses.UNKNOWN;\n};\n\n/**\n  Generates an array of history objects sense the previous state.\n  The object has the keys\n    op (the operation performed),\n    path (the key and if a nested object then each key will be separated with a `/`)\n    value\n  with the first entry having the note and a timestamp when the change took place\n  @param {Object} previousState - the previous state of the object\n  @param {Object} newState - the update object\n  @param {string} [note] - a optional note for the state change\n  @returns {Array}\n*/\nexport function generateHistoryEntry(\n  previousState: any,\n  newState: any,\n  note: string,\n) {\n  const entry: any = jsonDiffer.compare(previousState, newState);\n  // Add a note to the first op, since it breaks if we append it to the entry\n  if (entry[0]) {\n    if (note) {\n      entry[0].note = note;\n    }\n\n    entry[0].timestamp = Date.now();\n  }\n  return entry;\n}\n\n/**\n  Recovers previous txMeta state obj\n  @returns {Object}\n*/\nexport function replayHistory(_shortHistory: any) {\n  const shortHistory = cloneDeep(_shortHistory);\n  return shortHistory.reduce(\n    (val: any, entry: any) => jsonDiffer.applyPatch(val, entry).newDocument,\n  );\n}\n\n/**\n * Snapshot {@code txMeta}\n * @param {Object} txMeta - the tx metadata object\n * @returns {Object} a deep clone without history\n */\nexport function snapshotFromTxMeta(txMeta: any) {\n  const shallow = { ...txMeta };\n  delete shallow.history;\n  return cloneDeep(shallow);\n}\n\n/**\n * Returns processing time for an STX in seconds.\n * @param {number} smartTransactionSubmittedtime\n * @returns {number} Processing time in seconds.\n */\nexport const getStxProcessingTime = (\n  smartTransactionSubmittedtime: number | undefined,\n): number | undefined => {\n  if (!smartTransactionSubmittedtime) {\n    return undefined;\n  }\n  return Math.round((Date.now() - smartTransactionSubmittedtime) / 1000);\n};\n\nexport async function handleFetch(request: string, options?: RequestInit) {\n  const response = await fetch(request, options);\n  const json = await response.json();\n  if (!response.ok) {\n    const { error: type, error_details: message } = json;\n    console.log(`response`, response);\n    throw new Error(\n      `Fetch error:${JSON.stringify({\n        status: response.status,\n        type,\n        message,\n      })}`,\n    );\n  }\n  return json;\n}\n"]}